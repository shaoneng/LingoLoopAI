# LingoLoop AI 完整部署指南

## 目录
- [项目概述](#项目概述)
- [系统架构](#系统架构)
- [部署前准备](#部署前准备)
- [环境变量说明](#环境变量说明)
- [部署流程](#部署流程)
- [功能验证](#功能验证)
- [运维与监控](#运维与监控)
- [常见故障排除](#常见故障排除)
- [成本预估](#成本预估)
- [文档信息](#文档信息)

## 项目概述

LingoLoop AI 是一套基于 Next.js 14 的语音转写与学习平台。应用采用单体架构：同一代码库既提供前端页面，也通过 Next.js API 路由暴露服务端接口，并配合后台工作器处理长时音频转写任务。

- **框架**：Next.js 14、React 18、Tailwind CSS
- **服务端**：Next.js API Routes（Node.js 20 运行时）
- **数据库**：PostgreSQL，使用 Prisma ORM（`prisma/schema.prisma`）
- **云服务**：Google Cloud Storage、Speech-to-Text、Gemini Generative AI
- **后台任务**：`npm run worker` 启动的转写工作器，按队列轮询执行长任务

## 系统架构

```
┌──────────────────────────────────────────────────────────────────────┐
│                           LingoLoop AI 应用                           │
│                                                                      │
│  Next.js Web 服务器 (npm start / npx next start)                     │
│    • 静态页面与客户端交互                                            │
│    • API 路由 (pages/api/**)                                         │
│    • 访问 Prisma/PostgreSQL、Google Cloud API                        │
│                                                                      │
│  转写工作器 (npm run worker)                                         │
│    • 轮询 `job` 表                                                   │
│    • 调用 Google Speech/Gemini                                       │
│    • 更新 `transcriptRun` 状态并写审计日志                           │
└──────────────────────────────────────────────────────────────────────┘
            │                       │                         │
            ▼                       ▼                         ▼
      PostgreSQL 数据库      Google Cloud Storage      Google Speech / Gemini
```

部署时需要保证 Web 服务和工作器共享同一数据库与环境变量；可以在同一机器上以两个进程运行，也可以拆分为独立服务。

## 部署前准备

### 账号与资源
- **代码托管**：GitHub 或自建 Git 服务（可选）
- **运行平台**：自建服务器、Docker、Railway、Render 等支持 Node.js 20 的平台
- **数据库**：PostgreSQL 13+（可选用 Supabase、RDS、Cloud SQL 等托管服务）
- **Google Cloud**：启用 Speech-to-Text、Cloud Storage 与 Gemini API，创建服务账号并下载 JSON 凭证
- **邮件服务（可选）**：SendGrid 用于密码重置通知；若不配置，可将邮件模式设为 console 仅记录日志

### 本地工具
- Node.js 20 与 npm 10
- gcloud CLI（若需要上传服务账号或管理 GCS）
- Prisma CLI：通过 `npx prisma` 使用
- Docker（若采用容器部署）

### 代码获取

```bash
git clone <repo-url>
cd LingoLoopAI
npm install
npx prisma generate
```

## 环境变量说明

将以下变量写入 `.env.production`（或平台的 Secret 配置）。Web 与工作器需要同一套配置。

| 变量 | 必填 | 说明 |
| --- | --- | --- |
| `DATABASE_URL` | 是 | PostgreSQL 连接串，例如 `postgresql://user:pass@host:5432/db` |
| `AUTH_JWT_SECRET` | 是 | 用于签发访问令牌的随机长字符串 |
| `GCS_BUCKET` | 是 | Google Cloud Storage 桶名称，用于存储音频 |
| `GOOGLE_APPLICATION_CREDENTIALS` | 是 | 服务账号 JSON 文件路径或内容（某些平台需改用内联 secret） |
| `GCLOUD_PROJECT` | 是 | Google Cloud 项目 ID |
| `GEMINI_API_KEY` | 是 | Gemini Generative AI API 密钥（或 `GOOGLE_GENAI_API_KEY` / `GOOGLE_API_KEY`） |
| `NEXT_PUBLIC_API_BASE` | 是 | 前端调用 API 的基础 URL，单域部署可设为 `/` 或网站根域 |
| `NEXT_PUBLIC_API_BASE_URL` | 前端 | 某些旧页面使用该变量，建议与 `NEXT_PUBLIC_API_BASE` 保持一致 |
| `NEXT_PUBLIC_APP_BASE_URL` | 前端 | 邮件重置链接回跳地址；未配置时会从请求推断 |
| `CORS_ORIGIN` | 可选 | 允许的跨域来源，单域部署可留空（默认为 `*`） |
| `MAIL_FROM` | 邮件可选 | 发件人邮箱地址（用于 SendGrid） |
| `SENDGRID_API_KEY` | 邮件可选 | SendGrid API Key；缺省时将回退至 console 日志 |
| `UPLOAD_URL_TTL_SEC` 等配额变量 | 可选 | 上传与配额策略，参见 `lib/quota.js` |
| `TASKS_INLINE_PROCESSING` | 可选 | 设为 `1` 可在请求线程内执行任务，默认通过工作器异步处理 |

> **提示**：部分托管平台（如 Railway、Render）无法直接读取本地 JSON 文件，可将服务账号文件内容编码为单行字符串后写入 Secret，在启动脚本中写入临时文件并设置 `GOOGLE_APPLICATION_CREDENTIALS` 指向该路径。

## 部署流程

### 1. 准备环境配置
1. 复制 `.env.example` 为 `.env.production` 并按需填入变量。
2. 确认文件或 Secret 对运行用户可读。

### 2. 同步数据库

```bash
export $(cat .env.production | xargs) # 或在 shell 中逐一 export
npx prisma db push
npx prisma generate
```

数据库迁移完成后可选运行 `npx prisma studio` 验证表结构。

### 3. 构建与启动 Web 服务

```bash
npm run build
PORT=3000 npm start
```

默认监听 3000 端口，可通过 `PORT` 变量覆盖。若使用反向代理，请确保代理层转发 `x-forwarded-*` 头。

### 4. 启动转写工作器

在同一代码目录、同一环境变量集合下运行：

```bash
npm run worker
```

工作器日志会定期输出当前处理队列。生产环境建议使用 `pm2`、`systemd` 或平台自带的多进程配置，确保 Web 与 Worker 均已常驻。

### 5. Docker 部署（可选）

仓库内提供多阶段 `Dockerfile`，可用于 Cloud Run、Kubernetes 或自建集群：

```bash
docker build -t lingoloopai:latest .
docker run --env-file .env.production -p 8080:8080 lingoloopai:latest
```

如需同时运行 worker，可额外启动一个容器实例执行 `npm run worker`：

```bash
docker run --env-file .env.production lingoloopai:latest npm run worker
```

### 6. Railway/多进程平台

`railway.toml` 已定义 `web = "npm start"`、`worker = "npm run worker"`，部署时分别指定环境变量即可。收到额外需求时，可在平台后台配置健康检查路径（项目已内置 `/api/health`）。

## 功能验证

1. **基础检查**：访问首页 `/` 与登录页 `/login`，确保资源加载正常。
2. **注册与登录**：使用 `/register` 注册新账号，随后在 `/login` 登录，检查浏览器 LocalStorage 是否写入 `accessToken`。
3. **音频上传**：在 Dashboard 内上传小型音频文件（≤10 MB）。上传成功后应在数据库 `audioFile` 表看到记录，状态为 `processing`。
4. **工作器执行**：查看工作器日志，应出现 `Processing job ...` 与 `completed successfully`。数据库 `transcriptRun`、`job` 状态应更新为 `succeeded`。
5. **密码重置（可选）**：调用 `/forgot-password` 提交邮箱，验证是否触发邮件或 console 输出。
6. **Google API 权限**：若转写失败，检查服务账号是否具备 Speech-to-Text 与 Storage 访问权限。

## 运维与监控

- **日志**：保留 Web 与 Worker 的 stdout/stderr，便于排查任务失败原因。
- **数据库维护**：定期备份 PostgreSQL（`pg_dump`），并监控连接数、慢查询。
- **存储管理**：GCS 临时文件默认在转写完成后删除，如出现残留可按周期清理对应前缀。
- **密钥轮换**：定期更新 `AUTH_JWT_SECRET`、Google API Key 与 SendGrid Key，替换后重启服务。
- **容量规划**：关注 `usageLog` 与 `job` 表数据增长，必要时编写归档脚本。

## 常见故障排除

| 症状 | 可能原因 | 解决方案 |
| --- | --- | --- |
| Web 500 报错 `AUTH_JWT_SECRET is not configured` | 未配置密钥 | 检查环境变量并重启服务 |
| 上传接口返回 `Missing GCS_BUCKET env` | 未设置 GCS 桶 | 在配置中补充 `GCS_BUCKET`、`GCLOUD_PROJECT`、服务账号权限 |
| 工作器重复重试 | Google API 权限或音频损坏 | 查看工作器日志，确认服务账号角色及 GCS 文件是否可读 |
| `Error: MAIL_FROM is not configured` | 未配置邮件发件地址 | 设置 `MAIL_FROM` 或将 `MAIL_FALLBACK_MODE=console` |
| 数据库连接失败 | 防火墙/SSL/凭据错误 | 确认连接串、白名单与 TLS 设置；必要时启用 `sslmode=require` |
| 前端调用 API 报 CORS 错误 | 跨域限制不符 | 调整 `CORS_ORIGIN` 或使用同域部署 |

## 成本预估

| 项目 | 参考成本 |
| --- | --- |
| 计算资源 | Node.js Web + Worker 各 1 实例，可使用 Railway/Render 免费层或自建服务器 |
| PostgreSQL | Supabase 免费 500MB，或云数据库约 10-30 美元/月 |
| Google Cloud Storage | 依据存储量与出站流量计费，低流量阶段 <5 美元/月 |
| Speech-to-Text | 约 $0.006/分钟（视地区与模型而定） |
| Gemini API | 依用量计费，基础测试额度可免费 |
| SendGrid | 免费计划每日 100 封邮件 |

## 文档信息

- 最后更新：2025 年（基于最新代码结构）
- 维护者：LingoLoop AI 工程团队
- 关联文件：`DEPLOYMENT.md`、`railway.toml`、`DATABASE_SETUP.md`

如需进一步支持，请通过 Issue 或内部沟通渠道反馈。
