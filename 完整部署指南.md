# LingoLoop AI 完整部署指南

## 目录
- [项目概述](#项目概述)
- [系统架构](#系统架构)
- [部署前准备](#部署前准备)
- [环境变量说明](#环境变量说明)
- [部署流程](#部署流程)
- [功能验证](#功能验证)
- [运维与监控](#运维与监控)
- [常见故障排除](#常见故障排除)
- [成本预估](#成本预估)
- [文档信息](#文档信息)

## 项目概述

LingoLoop AI 是一套英语听力与转写平台，现已迁移至 **Cloudflare Pages + Cloudflare Workers** 架构：

- **前端**：静态化的 Next.js 14 应用构建并托管在 Cloudflare Pages。
- **后端 API**：使用 Cloudflare Workers（基于 Hono）承载认证、音频管理、转写调度等接口。
- **数据库**：PostgreSQL，通过 Prisma Accelerate（Data Proxy）在 Worker 环境访问。
- **云服务**：Google Cloud Storage、Speech-to-Text、Gemini AI 通过 REST API 调用。
- **后台任务（规划中）**：后续可接入 Cloudflare Queues + 消费者 Worker 处理长音频异步转写。

## 系统架构

```
┌──────────────────────────┐          ┌──────────────────────────┐
│  Cloudflare Pages        │          │  Cloudflare Workers      │
│  • 静态 Next.js 前端      │   HTTPS   │  • Hono API 层           │
│  • CDN + 证书            │◄────────►│  • Auth / Upload / Runs  │
│  • 读取 NEXT_PUBLIC_*    │          │  • 调用 Prisma Accelerate │
└──────────────────────────┘          │  • 与 GCP/Gemini 通信     │
                                      └──────────┬───────────────┘
                                                 │
                                     ┌───────────▼────────────┐
                                     │   外部依赖              │
                                     │   • PostgreSQL          │
                                     │   • Google Cloud APIs   │
                                     └────────────────────────┘
```

前端与后端各自部署在独立的 Cloudflare 服务中，通过环境变量共享配置。后端 Worker 需绑定 Prisma Accelerate、数据库及 Google APIs 的凭据；若未来启用队列，可另行增加消费者 Worker。

## 部署前准备

### 账号与资源
- **代码托管**：GitHub 或自建 Git 服务（可选）
- **运行平台**：自建服务器、Docker、Railway、Render 等支持 Node.js 20 的平台
- **数据库**：PostgreSQL 13+（可选用 Supabase、RDS、Cloud SQL 等托管服务）
- **Google Cloud**：启用 Speech-to-Text、Cloud Storage 与 Gemini API，创建服务账号并下载 JSON 凭证
- **邮件服务（可选）**：SendGrid 用于密码重置通知；若不配置，可将邮件模式设为 console 仅记录日志

### 本地工具
- Node.js 20 与 npm 10（用于本地构建前端、运行单元测试）
- gcloud CLI（管理 Google Cloud 资源）
- Prisma CLI 与 Accelerate 账户（生成 Edge 客户端）
- Wrangler CLI（部署 Cloudflare Workers/Queues）

### 代码获取与目录划分

仓库当前包含 `frontend/`（静态前端）与 `workers/`（Worker API）两个主要目录。

```bash
git clone <repo-url>
cd LingoLoopAI

# 前端依赖
cd frontend
npm install

# Workers API 依赖
cd ../workers
npm install
```

## 环境变量说明

将以下变量写入从 `.env.example` 复制出的 `.env.cloudflare`（本地开发使用），并在 Cloudflare Pages/Workers 的环境变量中配置。前端与后端共享部分变量，注意保密信息仅配置在 Worker 侧。

| 变量 | 部署面 | 必填 | 说明 |
| --- | --- | --- | --- |
| `NEXT_PUBLIC_API_BASE` | Pages | 是 | Cloudflare Worker API 根地址，例如 `https://api.example.workers.dev` |
| `NEXT_PUBLIC_APP_BASE_URL` | Pages | 是 | 前端站点根域，用于邮件链接 |
| `NEXT_PUBLIC_GOOGLE_OAUTH_CLIENT_ID` | Pages | 可选 | 前端 Google 登录配置 |
| `AUTH_JWT_SECRET` | Worker | 是 | JWT 签名密钥 |
| `PRISMA_ACCELERATE_URL` | Worker | 是 | Prisma Accelerate 连接串（`prisma://`） |
| `DATABASE_URL` | Worker | 可选 | 本地测试使用，线上建议仅用 Accelerate |
| `GCS_BUCKET` | Worker | 是 | Google Cloud Storage 桶名称 |
| `GCP_CLIENT_EMAIL` | Worker | 是 | 服务账号 email，用于生成 JWT |
| `GCP_PRIVATE_KEY` | Worker | 是 | 服务账号私钥（去掉换行，存为 Secret） |
| `GCLOUD_PROJECT` | Worker | 是 | Google Cloud 项目 ID |
| `GEMINI_API_KEY` | Worker | 是 | Gemini REST API Key |
| Queue 绑定（可选） | Worker | 否 | 如后续启用 Cloudflare Queues，再于 `wrangler.toml` 添加 `[[queues.producers]]` |
| `MAIL_FROM` / `SENDGRID_API_KEY` | Worker | 可选 | 邮件通知配置 |
| `CORS_ORIGIN` | Worker | 可选 | 允许的前端来源 |

> **提示**：Cloudflare Worker Secret 不支持上传整份 JSON，可将服务账号私钥拆分为 `GCP_CLIENT_EMAIL` 与单行 `GCP_PRIVATE_KEY`（换行替换为 `\n`）。

## 部署流程

### 1. 准备环境配置
1. 从 `.env.example` 复制 `.env.cloudflare`，并为 `frontend/.env.local`、`workers/.dev.vars` 填写本地开发值。
2. 在 Cloudflare Pages/Workers 控制台配置 Secrets，与 `.env.example` 保持一致。
3. 创建 Prisma Accelerate 项目，获取 `PRISMA_ACCELERATE_URL`。

### 2. 同步数据库

```bash
# 使用本地 Node 环境执行迁移（仅需一次）
export $(cat .env.cloudflare | xargs)
npx prisma db push
npx prisma generate --schema prisma/schema.prisma
```

数据库迁移完成后可选运行 `npx prisma studio` 验证表结构。部署前确保 Accelerate 已同步最新 schema。

### 3. 构建静态前端（Cloudflare Pages）

```bash
cd frontend
npm run build
npm run export
```

将生成的 `frontend/out` 上传到 Cloudflare Pages，或配置 Git 集成后通过 `npm run build && npm run export` 自动构建。

### 4. 部署 Cloudflare Workers API

```bash
cd ../workers
wrangler deploy
```

部署后记录 Worker 域名，在 Cloudflare Pages 的 `NEXT_PUBLIC_API_BASE` 中填写。

### 5.（可选）启用 Cloudflare Queue

> 目前仓库未包含队列消费者实现。如需异步转写，可于后续新增独立 Worker 并在 `workers/wrangler.toml` 中配置队列绑定。

### 6. 自定义域名与路由

1. 在 Pages/Workers 绑定自定义域，更新 `NEXT_PUBLIC_APP_BASE_URL`、`NEXT_PUBLIC_API_BASE`。
2. 可在 Worker 中配置自定义路由，例如 `api.example.com/*` 指向 Worker。

## 功能验证

1. **前端可用性**：访问 Cloudflare Pages 域名，检查静态资源与路由。
2. **API 健康**：调用 Worker `/api/health`，确认数据库连通。
3. **注册/登录**：通过前端完成注册与登录，检查 JWT 是否正确返回。
4. **音频上传**：上传小文件，确认 Worker 返回上传凭证，GCS 中出现对象。
5. **异步转写（启用时）**：任务应被推送到 Queue，消费者 Worker 日志显示处理并更新 `transcriptRun`。
6. **Google 服务**：确保 GCS 签名 URL、Speech-to-Text、Gemini 调用成功，若失败，检测服务账号权限与 API Key。

## 运维与监控

- **Worker 日志**：使用 `wrangler tail` 查看 API 与 Queue 消费者的实时日志。
- **Queue 监控（启用时）**：在 Cloudflare 控制台查看消息堆积量，合理配置重试与 DLQ（死信队列）。
- **数据库维护**：定期备份 PostgreSQL，并关注 Accelerate Token 轮换。
- **GCS 清理**：自动删除临时文件（Queue 处理成功后），必要时配置生命周期规则。
- **密钥轮换**：通过 Cloudflare Secrets 更新所有凭证；更新后重新部署 Worker。
- **费用监控**：关注 Cloudflare、GCP API、PostgreSQL 托管服务成本。

## 常见故障排除

| 症状 | 可能原因 | 解决方案 |
| --- | --- | --- |
| Worker 返回 500 `AUTH_JWT_SECRET is not configured` | Secrets 未配置 | 在 Cloudflare Worker 环境变量中补齐密钥后重新部署 |
| Prisma 报错 `Unable to reach Accelerate` | Accelerate URL 或 Token 有误 | 重新生成 Data Proxy URL 并更新 Secret |
| 上传失败 `Missing GCS bucket` | 未配置 GCS 变量 | 检查 `GCS_BUCKET`、`GCLOUD_PROJECT`、`GCP_PRIVATE_KEY` 等 |
| Queue 消费者无日志 | 队列未绑定或部署失败 | 检查 `wrangler queues list`，确认 Worker 已绑定并部署成功 |
| Speech-to-Text 返回权限错误 | 服务账号缺少权限 | 在 GCP 控制台为服务账号授予 `Speech-to-Text Admin`, `Storage Object Admin` |
| 前端 CORS 被拦截 | Worker 响应头未允许来源 | 调整 `CORS_ORIGIN`，或在 Hono 中设置 `Access-Control-Allow-Origin` |

## 成本预估

| 项目 | 参考成本 |
| --- | --- |
| Cloudflare Pages | 免费层含足够构建次数；自定义域名亦免费 |
| Cloudflare Workers | 免费层每日 100k 请求 + 100 万 Queue 消息；超出后按量收费 |
| Cloudflare Queues | 免费额度内含 1 百万条消息，超额 $0.40/百万条 |
| PostgreSQL | Supabase 免费 500MB，或云数据库约 10-30 美元/月 |
| Google Cloud Storage | 按存储量与出站流量计费，低流量阶段 <5 美元/月 |
| Speech-to-Text | 约 $0.006/分钟（视地区与模型而定） |
| Gemini API | 依用量计费，基础测试额度可免费 |
| SendGrid | 免费计划每日 100 封邮件 |

## 文档信息

- 最后更新：2025 年（Cloudflare 架构）
- 维护者：LingoLoop AI 工程团队
- 关联文件：`docs/cloudflare-deployment-beginner.md`、`docs/cloudflare-deployment-steps.md`、`DEPLOYMENT.md`、`railway.toml`、`DATABASE_SETUP.md`

如需进一步支持，请通过 Issue 或内部沟通渠道反馈。


已经完成了！！